const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CAgIQmcy.js","assets/index-Pe1Nv6hH.js","assets/index-BoEWxluP.css","assets/slate-markdown-C4u7coMV.js","assets/dropdown-menu-CbU9G1H2.js","assets/index-SpxnGYUf.js","assets/createLucideIcon-BU8aI1FG.js","assets/index-4GH7Kv3S.js","assets/index-C8jai3VV.js","assets/index-D68Ta3NN.js","assets/index-BDzuQ5ZL.js","assets/chevron-right-COcvBQ44.js","assets/dialog-DHifiqsD.js","assets/input-DW-mBlUw.js","assets/form-DU65aaqX.js","assets/index-DGhUbGt9.js","assets/unlink-DFLq-BTp.js","assets/image-D4KB7jNL.js","assets/minus-BV34uZJO.js"])))=>i.map(i=>d[i]);
import{a as oe,l as ge,r as x,t as L,j as e,B as E,f as Q,u as Ae,A as Me,aj as Oe,C as S,Q as Y,M as qe,ai as Le}from"./index-Pe1Nv6hH.js";import{h as ze,b as y,c as v,d as k,e as b,f as N,u as Re,a as Ke,F as Be}from"./form-DU65aaqX.js";import{u as R}from"./useQuery-DDON36P9.js";import{u as ae}from"./useMutation-uvHqRPk1.js";import{T as ne}from"./textarea-D-N386t0.js";import{S as _e}from"./index-BmISbovJ.js";import{E as He}from"./editor-error-boundary-8LYWESTP.js";import{R as Qe}from"./index-B79q5nRO.js";import{a as $e,s as Ue}from"./slate-markdown-C4u7coMV.js";import{g as je,h as ye,i as ve,j as be,k as we,l as Ne}from"./sidebar-BFSPGCEL.js";import{S as De}from"./scroll-area-BCr0FWtA.js";import{I as re}from"./input-DW-mBlUw.js";import{S as he}from"./switch-BUI-ezYi.js";import{S as K,a as B,b as _,c as H,d as M}from"./select-Dl4KSF7A.js";import{g as Je,a as We,b as Ge,c as Xe,d as Ye,e as Ze}from"./command-D9eDedTW.js";import{P as et,a as tt,b as rt}from"./popover-CrxLZKyN.js";import{B as st}from"./badge-T19Q3klL.js";import{a as at,f as nt}from"./date-picker-DZceGXqu.js";import{c as ot,g as ct}from"./tag-BQ1zh2fc.js";import{S as it}from"./settings-CTuF3-1m.js";import{X as Ie}from"./index-D68Ta3NN.js";import{C as lt}from"./chevrons-up-down-BrdDDp5G.js";import{P as pe,A as xe}from"./plus-w5piNt_B.js";import{C as dt}from"./index-SpxnGYUf.js";import{T as ut}from"./trash-2-DxKhJZhR.js";import{I as se}from"./image-D4KB7jNL.js";import{W as mt}from"./wand-sparkles-DDvxT50Q.js";import{V as fe}from"./video-Bs8fCpLF.js";import{c as ht,u as pt,a as xt}from"./post-BNqlxPPd.js";import{g as ft}from"./category-DZrOWX3M.js";import{g as gt}from"./project-_pxXE-N5.js";import{g as jt}from"./user-D0YkkhRV.js";const yt=()=>{const d="0123456789ABCDEF";let j="#";for(let t=0;t<6;t++)j+=d[Math.floor(Math.random()*16)];return j};function vt({open:d,onOpenChange:j,form:t,userList:g,tagList:c,projectList:l,flattenCategories:m,extFields:F,setExtFields:C}){const{t:o}=oe(),$=ge(),[D,U]=x.useState(""),A=x.useRef(null);x.useEffect(()=>{const a=A.current;if(a&&c.length>0){const n=c.find(u=>u.title===a);if(n){const u=t.getValues("tag"),r=u?u.split(",").filter(Boolean):[];if(n.tagID&&!r.includes(n.tagID)){const f=[...r,n.tagID];t.setValue("tag",f.join(",")),L.success(o("features.content.tag.createSuccess"))}A.current=null}}},[c,t,o]);const z=ae({mutationFn:ot,onSuccess:()=>{$.invalidateQueries({queryKey:["tagList"]})},onError:()=>{L.error(o("features.content.tag.createError")),A.current=null}}),Z=ze({control:t.control,name:"isPasswd"});return e.jsxs(je,{open:d,onOpenChange:j,children:[e.jsx(ye,{asChild:!0,children:e.jsxs(E,{variant:"outline",size:"sm",type:"button",children:[e.jsx(it,{className:"h-4 w-4 mr-2"}),o("features.content.article.form.tabOtherInfo")]})}),e.jsxs(ve,{className:"w-[400px] sm:w-[540px] p-0",children:[e.jsxs(be,{className:"px-6 py-4 border-b",children:[e.jsx(we,{children:o("features.content.article.form.tabOtherInfo")}),e.jsx(Ne,{children:o("features.content.article.form.editDescription")})]}),e.jsx(De,{className:"h-[calc(100vh-80px)] px-6 py-4",children:e.jsxs("div",{className:"space-y-6 pb-8",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(y,{control:t.control,name:"type",render:({field:a})=>e.jsxs(v,{children:[e.jsx(k,{children:o("features.content.article.form.type")}),e.jsxs(K,{onValueChange:n=>a.onChange(Number(n)),value:a.value?.toString(),children:[e.jsx(b,{children:e.jsx(B,{children:e.jsx(_,{placeholder:o("features.content.article.form.typePlaceholder")})})}),e.jsxs(H,{children:[e.jsx(M,{value:"1",children:o("features.content.article.form.typeArticle")}),e.jsx(M,{value:"2",children:o("features.content.article.form.typePage")}),e.jsx(M,{value:"3",children:o("features.content.article.form.typeShortPost")})]})]}),e.jsx(N,{})]})}),e.jsx(y,{control:t.control,name:"status",render:({field:a})=>e.jsxs(v,{children:[e.jsx(k,{children:o("features.content.article.form.status")}),e.jsxs(K,{onValueChange:n=>a.onChange(Number(n)),value:a.value?.toString(),children:[e.jsx(b,{children:e.jsx(B,{children:e.jsx(_,{placeholder:o("features.content.article.form.statusPlaceholder")})})}),e.jsxs(H,{children:[e.jsx(M,{value:"1",children:o("features.content.article.status.draft")}),e.jsx(M,{value:"2",children:o("features.content.article.status.published")})]})]}),e.jsx(N,{})]})})]}),e.jsx(y,{control:t.control,name:"categoryID",render:({field:a})=>{const n=a.value!=null&&a.value!==""?String(a.value).trim():"",u=n!==""?m.find(r=>(r.id??"").trim()===n):void 0;return e.jsxs(v,{children:[e.jsx(k,{children:o("features.content.article.form.category")}),e.jsxs(K,{onValueChange:r=>a.onChange(r?r.trim():""),value:n||void 0,children:[e.jsx(b,{children:e.jsx(B,{children:u?e.jsx("span",{className:"line-clamp-1 truncate",children:u.title.trim()}):e.jsx(_,{placeholder:o("features.content.article.form.categoryPlaceholder")})})}),e.jsx(H,{children:m.map(r=>e.jsx(M,{value:r.id,children:e.jsx("span",{style:{paddingLeft:`${r.level*10}px`},children:r.title.trim()})},r.id))})]}),e.jsx(N,{})]})}}),e.jsx(y,{control:t.control,name:"projectID",render:({field:a})=>{const n=a.value!=null&&a.value!==""?String(a.value).trim():"",u=n!==""?l.find(r=>(r.projectID??"").trim()===n):void 0;return e.jsxs(v,{children:[e.jsx(k,{children:o("features.content.article.filter.project")}),e.jsxs(K,{onValueChange:a.onChange,value:a.value||void 0,children:[e.jsx(b,{children:e.jsx(B,{children:u?e.jsx("span",{className:"line-clamp-1 flex items-center",children:u.title}):e.jsx(_,{placeholder:o("features.content.article.form.projectPlaceholder")})})}),e.jsx(H,{children:l.map(r=>e.jsx(M,{value:String(r.projectID??"").trim(),children:r.title},r.projectID))})]}),e.jsx(N,{})]})}}),e.jsx(y,{control:t.control,name:"tag",render:({field:a})=>{const n=a.value?a.value.split(",").filter(Boolean):[],u=c.filter(r=>n.includes(r.tagID));return e.jsxs(v,{children:[e.jsx(k,{children:o("features.content.article.form.tag")}),e.jsxs(et,{children:[e.jsx(tt,{asChild:!0,children:e.jsx(b,{children:e.jsxs(E,{variant:"outline",role:"combobox",className:Q("w-full justify-between h-auto min-h-10",!n.length&&"text-muted-foreground"),children:[e.jsx("div",{className:"flex flex-wrap gap-1",children:u.length>0?u.map(r=>e.jsxs(st,{variant:"secondary",className:"mr-1",children:[r.title,e.jsx("div",{className:"ml-1 ring-offset-background rounded-full outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 cursor-pointer",onMouseDown:f=>{f.preventDefault(),f.stopPropagation()},onClick:f=>{f.preventDefault(),f.stopPropagation();const V=n.filter(O=>O!==r.tagID);a.onChange(V.join(","))},children:e.jsx(Ie,{className:"h-3 w-3 text-muted-foreground hover:text-foreground"})})]},r.tagID)):e.jsx("span",{children:o("features.content.article.form.tagPlaceholder")})}),e.jsx(lt,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),e.jsx(rt,{className:"w-[400px] p-0",align:"start",children:e.jsxs(Je,{children:[e.jsx(We,{placeholder:o("features.content.article.form.tagPlaceholder"),value:D,onValueChange:U}),e.jsxs(Ge,{children:[e.jsx(Xe,{children:D&&!c.some(r=>r.title===D)?e.jsxs("div",{className:"flex items-center p-2 text-sm cursor-pointer hover:bg-accent hover:text-accent-foreground",onMouseDown:r=>{r.preventDefault(),r.stopPropagation()},onClick:r=>{r.preventDefault(),r.stopPropagation(),A.current=D,z.mutate({title:D,description:D,color:yt()}),U("")},children:[e.jsx(pe,{className:"mr-2 h-4 w-4"}),o("features.content.tag.createButton"),' "',D,'"']}):"No tag found."}),e.jsx(Ye,{children:c.map(r=>e.jsxs(Ze,{value:r.title,onSelect:()=>{const f=n.includes(r.tagID);let V;f?V=n.filter(O=>O!==r.tagID):V=[...n,r.tagID],a.onChange(V.join(","))},children:[e.jsx(dt,{className:Q("mr-2 h-4 w-4",n.includes(r.tagID)?"opacity-100":"opacity-0")}),r.title]},r.tagID))})]})]})})]}),e.jsx(N,{})]})}}),e.jsx(y,{control:t.control,name:"showTime",render:({field:a})=>e.jsxs(v,{children:[e.jsx(k,{children:o("features.content.article.form.showTime")}),e.jsx(b,{children:e.jsx(at,{selected:a.value,onSelect:a.onChange,placeholder:o("features.content.article.form.showTimePlaceholder")})}),e.jsx(N,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(y,{control:t.control,name:"isTop",render:({field:a})=>e.jsxs(v,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(k,{className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:o("features.content.article.form.isTop")}),e.jsx(b,{children:e.jsx(he,{checked:a.value===2,onCheckedChange:n=>a.onChange(n?2:1)})})]})}),e.jsx(y,{control:t.control,name:"isPasswd",render:({field:a})=>e.jsxs(v,{className:"flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm",children:[e.jsx(k,{className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:o("features.content.article.form.isPasswd")}),e.jsx(b,{children:e.jsx(he,{checked:a.value===2,onCheckedChange:n=>a.onChange(n?2:1)})})]})})]}),Z===2&&e.jsx(y,{control:t.control,name:"password",render:({field:a})=>e.jsxs(v,{children:[e.jsx(k,{children:o("features.content.article.form.password")}),e.jsx(b,{children:e.jsx(re,{type:"password",placeholder:o("features.content.article.form.passwordPlaceholder"),...a})}),e.jsx(N,{})]})}),e.jsx(y,{control:t.control,name:"author",render:({field:a})=>e.jsxs(v,{children:[e.jsx(k,{children:o("features.content.article.form.author")}),e.jsx(b,{children:e.jsxs(K,{onValueChange:n=>{const u=g.find(r=>r.userID===n);u&&(a.onChange(u.nickname||u.username),t.setValue("userID",u.userID))},value:g.find(n=>(n.nickname||n.username)===a.value)?.userID??"",children:[e.jsx(B,{children:e.jsx(_,{placeholder:o("features.content.article.form.authorPlaceholder")})}),e.jsx(H,{children:g.map(n=>e.jsx(M,{value:n.userID,children:n.nickname||n.username},n.userID))})]})}),e.jsx(N,{})]})}),e.jsxs("div",{className:"space-y-3 pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:o("features.content.article.form.extCustom")}),e.jsxs(E,{type:"button",variant:"outline",size:"sm",onClick:()=>C(a=>[...a,{key:"",value:""}]),children:[e.jsx(pe,{className:"h-4 w-4 mr-1"}),o("features.content.article.form.extAdd")]})]}),e.jsx("div",{className:"space-y-2",children:F.map((a,n)=>e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(re,{placeholder:o("features.content.article.form.extKeyPlaceholder"),value:a.key,onChange:u=>C(r=>{const f=[...r];return f[n]={...f[n],key:u.target.value},f}),className:"flex-1 min-w-0 font-mono text-sm"}),e.jsx(re,{placeholder:o("features.content.article.form.extValuePlaceholder"),value:a.value,onChange:u=>C(r=>{const f=[...r];return f[n]={...f[n],value:u.target.value},f}),className:"flex-1 min-w-0 font-mono text-sm"}),e.jsx(E,{type:"button",variant:"ghost",size:"icon",className:"shrink-0 text-muted-foreground hover:text-destructive",onClick:()=>C(u=>u.filter((r,f)=>f!==n)),"aria-label":o("features.content.article.form.extDelete"),children:e.jsx(ut,{className:"h-4 w-4"})})]},n))})]})]})})]})]})}function bt({open:d,onOpenChange:j,form:t,onOpenResourceUpload:g}){const{t:c}=oe(),l=()=>{const m=t.getValues("content");if(m)try{const F=JSON.parse(m),o=$e(F).slice(0,200).replace(/\s+/g," ").trim();o&&(t.setValue("description",o,{shouldDirty:!0}),L.success(c("features.content.article.descriptionExtracted")))}catch{}};return e.jsxs(je,{open:d,onOpenChange:j,children:[e.jsx(ye,{asChild:!0,children:e.jsxs(E,{variant:"outline",size:"sm",type:"button",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),c("features.content.article.form.tabMedia")]})}),e.jsxs(ve,{className:"w-[400px] sm:w-[540px] p-0",children:[e.jsxs(be,{className:"px-6 py-4 border-b",children:[e.jsx(we,{children:c("features.content.article.form.tabMedia")}),e.jsx(Ne,{children:c("features.content.article.form.mediaDescription")})]}),e.jsx(De,{className:"h-[calc(100vh-80px)] px-6 py-4",children:e.jsxs("div",{className:"space-y-6 pb-8",children:[e.jsx(y,{control:t.control,name:"description",render:({field:m})=>e.jsxs(v,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(k,{children:c("features.content.article.form.description")}),e.jsxs(E,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:l,children:[e.jsx(mt,{className:"w-3 h-3 mr-1"}),c("features.content.article.form.extractDescription")]})]}),e.jsx(b,{children:e.jsx(ne,{placeholder:c("features.content.article.form.descriptionPlaceholder"),className:"resize-none min-h-[88px]",...m})}),e.jsx(N,{})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:[c("features.content.article.form.cover")," / ",c("features.content.article.form.video")]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsx(y,{control:t.control,name:"icon",render:({field:m})=>e.jsxs(v,{className:"space-y-0",children:[e.jsx(b,{children:e.jsx("button",{type:"button",onClick:()=>g("icon"),className:Q("flex flex-col items-center justify-center h-20 w-20 rounded-lg border-2 border-dashed border-border bg-muted/30 overflow-hidden transition-all shrink-0","cursor-pointer hover:border-primary/50 hover:bg-muted/50"),children:m.value?e.jsx("img",{src:m.value,alt:"",className:"h-full w-full object-cover"}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"h-8 w-8 text-muted-foreground mb-1"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:c("features.content.article.form.selectCover")})]})})}),e.jsx(N,{})]})}),e.jsx(y,{control:t.control,name:"video",render:({field:m})=>e.jsxs(v,{className:"space-y-0",children:[e.jsx(b,{children:e.jsx("button",{type:"button",onClick:()=>g("video"),className:Q("flex flex-col items-center justify-center h-20 w-20 rounded-lg border-2 border-dashed border-border bg-muted/30 overflow-hidden transition-all shrink-0","cursor-pointer hover:border-primary/50 hover:bg-muted/50"),children:m.value?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center bg-muted/30 p-1",children:[e.jsx(fe,{className:"h-8 w-8 text-muted-foreground mb-1 shrink-0"}),e.jsx("span",{className:"text-xs text-muted-foreground truncate w-full text-center",children:m.value.split("/").pop()})]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"h-8 w-8 text-muted-foreground mb-1"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:c("features.content.article.form.selectVideo")})]})})}),e.jsx(N,{})]})})]})]}),e.jsx(y,{control:t.control,name:"images",render:({field:m})=>e.jsxs(v,{children:[e.jsx(k,{className:"text-muted-foreground text-sm",children:c("features.content.article.form.moreImages")}),e.jsx(b,{children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(m.value??[]).map((F,C)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:F,alt:"",className:"h-20 w-20 rounded-lg border object-cover shrink-0"}),e.jsx("button",{type:"button",onClick:()=>{const o=(m.value??[]).filter(($,D)=>D!==C);m.onChange(o)},className:"absolute top-0.5 right-0.5 h-5 w-5 rounded-full bg-background/95 text-foreground shadow-sm border border-border flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-muted","aria-label":c("features.content.article.form.removeImage"),children:e.jsx(Ie,{className:"h-3 w-3"})})]},`${F}-${C}`)),e.jsxs("button",{type:"button",onClick:()=>g("images"),className:Q("flex flex-col items-center justify-center h-20 w-20 rounded-lg border-2 border-dashed border-border bg-muted/30 shrink-0","cursor-pointer hover:border-primary/50 hover:bg-muted/50"),children:[e.jsx(se,{className:"h-8 w-8 text-muted-foreground mb-1"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:c("features.content.article.form.addImage")})]})]})}),e.jsx(N,{})]})})]})})]})]})}const wt=x.lazy(()=>Le(()=>import("./index-CAgIQmcy.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18])).then(d=>({default:d.SlateEditor})));function Nt(d,j,t){const g=j.trim().split(".").map(l=>l.trim()).filter(Boolean);if(g.length===0)return;let c=d;for(let l=0;l<g.length-1;l++){const m=g[l];(!(m in c)||typeof c[m]!="object"||c[m]===null||Array.isArray(c[m]))&&(c[m]={}),c=c[m]}c[g[g.length-1]]=t}function Ce(d,j=""){const t=[];for(const[g,c]of Object.entries(d)){const l=j?`${j}.${g}`:g;c!==null&&typeof c=="object"&&!Array.isArray(c)&&Object.getPrototypeOf(c)===Object.prototype?t.push(...Ce(c,l)):t.push({key:l,value:c!=null?String(c):""})}return t}const Dt=d=>Me({title:S().min(1,d("features.content.article.form.validation.titleRequired")),description:S().min(1,d("features.content.article.form.validation.descriptionRequired")),author:S().min(1,d("features.content.article.form.validation.authorRequired")),userID:S().optional(),content:S().optional(),icon:S().optional(),video:S().optional(),images:qe(S()).optional(),type:Y().min(1,d("features.content.article.form.validation.typeRequired")),status:Y().default(1),categoryID:S().min(1,d("features.content.article.form.validation.categoryRequired")),projectID:S().min(1,d("features.content.article.form.validation.projectRequired")),isTop:Y().optional(),isPasswd:Y().optional(),password:S().optional(),tag:S().optional(),showTime:Oe().optional()});function sr({postID:d,initialPost:j}){const{t}=oe(),g=Ae(),c=ge(),l=!!d,m=x.useMemo(()=>Dt(t),[t]),[F,C]=x.useState(!1),[o,$]=x.useState(1),[D,U]=x.useState(null),[A,z]=x.useState([]),[Z,a]=x.useState(!1),[n,u]=x.useState(!1),{data:r}=R({queryKey:["categoryTree"],queryFn:ft}),{data:f}=R({queryKey:["projectList",{current:1,pageNum:1,pageSize:1e3}],queryFn:()=>gt({current:1,pageNum:1,pageSize:1e3})}),V=x.useMemo(()=>f?.projects??[],[f?.projects]),{data:O}=R({queryKey:["userList",{current:1,pageNum:1,pageSize:1e3}],queryFn:()=>jt({current:1,pageNum:1,pageSize:1e3})}),q=x.useMemo(()=>O?.users??[],[O?.users]),{data:ce}=R({queryKey:["tagList",{pageNum:1,pageSize:1e3}],queryFn:()=>ct({pageNum:1,pageSize:1e3})}),Se=x.useMemo(()=>ce?.tags??[],[ce?.tags]),J=x.useMemo(()=>{const s=[],h=(w,T=0)=>{w.forEach(I=>{s.push({id:String(I.categoryID??"").trim(),title:I.title,level:T}),I.children?.length&&h(I.children,T+1)})};return r?.categoryTree&&h(r.categoryTree),s},[r]),p=Re({resolver:Ke(m),defaultValues:{title:"",description:"",author:"",userID:"",content:"",icon:"",video:"",images:[],type:1,status:1,categoryID:"",projectID:"",isTop:1,isPasswd:1,password:"",tag:"",showTime:new Date}}),{data:ke,isLoading:ie}=R({queryKey:["post",d],queryFn:()=>xt(d),enabled:!!l&&!!d&&!j}),i=d?j??ke??null:null,Te=l&&!!d&&!j&&ie,Pe=l&&!!d&&!j&&!ie&&!i;x.useEffect(()=>{if(i){const h=(i.categoryID||(i.category&&typeof i.category=="object"&&"categoryID"in i.category?String(i.category.categoryID):"")).trim(),T=(i.projectID||(i.project&&typeof i.project=="object"&&"projectID"in i.project?String(i.project.projectID):"")).trim(),I={title:i.title||"",description:i.description||"",author:i.author||"",userID:i.userID||"",content:i.content||"",icon:i.icon||"",video:i.video||"",images:Array.isArray(i.images)?i.images:[],type:i.type||1,status:[1,2].includes(Number(i.status))?Number(i.status):1,categoryID:h||"",projectID:T||"",isTop:i.isTop??1,isPasswd:i.isPasswd??1,password:i.password||"",tag:i.tag||"",showTime:i.showTime?new Date(i.showTime):i.createdAt?new Date(i.createdAt):new Date};p.reset(I);let P=[];try{const me=(i.ext??"").trim();if(me){const X=JSON.parse(me);X&&typeof X=="object"&&!Array.isArray(X)&&(P=Ce(X))}}catch{}const Fe=setTimeout(()=>{z(P),h&&p.setValue("categoryID",h),T&&p.setValue("projectID",T),p.setValue("status",I.status)},0);return()=>clearTimeout(Fe)}else if(!l){p.reset({title:"",description:"",author:"",userID:"",content:"",icon:"",video:"",images:[],type:1,status:1,categoryID:"",projectID:"",isTop:1,isPasswd:1,password:"",tag:"",showTime:new Date});const s=setTimeout(()=>z([]),0);return()=>clearTimeout(s)}},[i,l]),x.useEffect(()=>{!l&&q.length>0&&(p.getValues("author")||(p.setValue("author",q[0].nickname||q[0].username),p.setValue("userID",q[0].userID)))},[l,q]),x.useEffect(()=>{if(!l&&J.length>0&&!p.getValues("categoryID")?.trim()){const h=J.find(w=>(w.id??"").trim()!=="");h&&p.setValue("categoryID",h.id)}},[l,J]),x.useEffect(()=>{!l&&V.length>0&&(p.getValues("projectID")||p.setValue("projectID",V[0].projectID))},[l,V]);const W=ae({mutationFn:s=>ht(s),onSuccess:()=>{L.success(t("features.content.article.createSuccess")),c.invalidateQueries({queryKey:["postList"]}),g({to:"/content/article"})}}),G=ae({mutationFn:({postID:s,...h})=>pt(s,h),onSuccess:()=>{L.success(t("features.content.article.updateSuccess")),c.invalidateQueries({queryKey:["postList"]}),g({to:"/content/article"})}}),le=W.mutate,de=G.mutate,ee=x.useCallback(s=>{const h=["description","icon","video","images"],w=["type","status","categoryID","projectID","tag","showTime","isTop","isPasswd","password","author"],T=Object.keys(s).some(P=>h.includes(P));T&&u(!0);const I=Object.keys(s).some(P=>w.includes(P));I&&a(!0),(T||I)&&L.error(t("features.content.article.form.validationErrorInSheet"))},[t]),te=x.useCallback(async s=>{if(W.isPending||G.isPending)return;const h=Ue(s.content??""),w={};A.filter(P=>P.key.trim()!=="").forEach(P=>Nt(w,P.key.trim(),P.value.trim()));const T=Object.keys(w).length>0?JSON.stringify(w):"",I={title:s.title,description:s.description,author:s.author,userID:s.userID,content:s.content,htmlContent:h,ext:T,icon:s.icon,video:s.video,images:s.images,type:s.type,status:s.status??1,categoryID:s.categoryID,projectID:s.projectID,isTop:s.isTop,isPasswd:s.isPasswd,password:s.password,tag:s.tag,showTime:s.showTime?nt(s.showTime,"yyyy-MM-dd HH:mm:ss"):void 0};l&&d?de({...I,postID:d}):le(I)},[A,l,d,le,de,W.isPending,G.isPending]);x.useEffect(()=>{const s=h=>{(h.metaKey||h.ctrlKey)&&h.key==="s"&&(h.preventDefault(),p.handleSubmit(te,ee)())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[p,te,ee]);const Ve=s=>{if(D==="images"){const h=p.getValues("images")??[];p.setValue("images",[...h,s.url])}else D&&p.setValue(D,s.url);C(!1)},Ee=s=>{U(s),$(s==="video"?2:1),C(!0)},ue=W.isPending||G.isPending;return Te?e.jsx("div",{className:"flex items-center justify-center min-h-[200px] px-4",children:e.jsx("p",{className:"text-muted-foreground",children:t("features.content.article.loading")})}):Pe?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[200px] px-4 gap-4",children:[e.jsx("p",{className:"text-muted-foreground",children:t("features.content.article.notFound")}),e.jsxs(E,{variant:"outline",onClick:()=>g({to:"/content/article"}),children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),t("features.content.article.form.backToList")]})]}):e.jsxs("div",{className:"flex flex-col h-[calc(100vh-4rem)] bg-background",children:[e.jsx(Be,{...p,children:e.jsxs("form",{onSubmit:p.handleSubmit(te,ee),className:"flex flex-col h-full",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between px-4 py-3 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/80 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx(E,{type:"button",variant:"ghost",size:"icon",className:"shrink-0",onClick:()=>g({to:"/content/article"}),"aria-label":t("features.content.article.form.cancel"),children:e.jsx(xe,{className:"h-4 w-4"})}),e.jsx(_e,{title:t(l?"features.content.article.form.editTitle":"features.content.article.form.createTitle"),description:t(l?"features.content.article.form.editDescription":"features.content.article.form.createDescription")})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsx(bt,{open:n,onOpenChange:u,form:p,onOpenResourceUpload:Ee}),e.jsx(vt,{open:Z,onOpenChange:a,form:p,userList:q,tagList:Se,projectList:V,flattenCategories:J,extFields:A,setExtFields:z}),e.jsx(E,{type:"submit",disabled:ue,children:t(ue?"features.content.article.form.submitting":l?"features.content.article.form.save":"features.content.article.form.create")})]})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto",children:e.jsxs("div",{className:"mx-auto w-full max-w-[42rem] px-5 sm:px-8 pt-8 pb-24",children:[e.jsx(y,{control:p.control,name:"title",render:({field:s})=>e.jsxs(v,{className:"space-y-0",children:[e.jsx(b,{children:e.jsx(ne,{placeholder:t("features.content.article.form.titlePlaceholder"),className:"text-3xl sm:text-4xl font-bold border-none resize-none shadow-none focus-visible:ring-0 px-0 py-0 min-h-[2.5rem] overflow-hidden leading-snug placeholder:text-muted-foreground/50 tracking-tight",rows:1,autoFocus:!0,onInput:h=>{const w=h.target;w.style.height="auto",w.style.height=`${w.scrollHeight}px`},...s})}),e.jsx(N,{})]})}),e.jsx("div",{className:"h-2","aria-hidden":!0}),e.jsx(y,{control:p.control,name:"content",render:({field:s})=>e.jsxs(v,{className:"flex flex-col min-h-0",children:[e.jsx(b,{children:e.jsx(He,{fallback:e.jsxs("div",{className:"rounded-md border border-input bg-background flex flex-col flex-1 items-center justify-center text-muted-foreground min-h-[320px]",children:[e.jsx("p",{className:"text-sm mb-2",children:t("features.content.article.form.editorLoadError")}),e.jsx(ne,{className:"max-w-2xl w-full min-h-[120px] font-mono text-xs resize-none",value:s.value??"",onChange:s.onChange,placeholder:t("features.content.article.form.contentPlaceholder"),readOnly:!1})]}),children:e.jsx(x.Suspense,{fallback:e.jsx("div",{className:"flex flex-col items-center justify-center text-muted-foreground min-h-[320px]",children:e.jsx("p",{className:"text-sm",children:t("features.content.article.form.editorLoading")})}),children:e.jsx(wt,{value:s.value??"",onChange:s.onChange,minHeight:"min-h-[60vh]",outputMode:"json",autoHeight:!0,className:"border-none shadow-none px-0 text-[1.0625rem] leading-[1.75]"})})})}),e.jsx(N,{})]})})]})})]})}),e.jsx(Qe,{open:F,onOpenChange:C,type:o,onSelect:Ve})]})}export{sr as A};
