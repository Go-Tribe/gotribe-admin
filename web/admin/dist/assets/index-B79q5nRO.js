import{l as Q,r as a,t as P,j as e,B as x,f as b}from"./index-Pe1Nv6hH.js";import{u as W}from"./useQuery-DDON36P9.js";import{u as X}from"./useMutation-uvHqRPk1.js";import{D as Z,a as J,b as ee,c as se,d as te}from"./dialog-DHifiqsD.js";import{S as ae}from"./scroll-area-BCr0FWtA.js";import{u as ie,F as t,g as le}from"./resource-u0oZDgOZ.js";import{L as F}from"./loader-circle-DjNfctPA.js";import{U as re,F as ne}from"./upload-CE8x_1SM.js";import{C as M}from"./index-SpxnGYUf.js";import{C as ce}from"./chevron-left-BrCT33MH.js";import{C as oe}from"./chevron-right-COcvBQ44.js";function O(i){return i?i<1024?`${i} B`:i<1024*1024?`${(i/1024).toFixed(1)} KB`:`${(i/(1024*1024)).toFixed(1)} MB`:"-"}const de={[t.IMAGE]:"暂无图片",[t.VIDEO]:"暂无视频",[t.AUDIO]:"暂无音频",[t.ARCHIVE]:"暂无压缩包",[t.DOCUMENT]:"暂无文档",[t.FONT]:"暂无字体",[t.APP]:"暂无应用",[t.UNKNOWN]:"暂无资源"},me={[t.IMAGE]:"上传图片",[t.VIDEO]:"上传视频",[t.AUDIO]:"上传音频",[t.ARCHIVE]:"上传",[t.DOCUMENT]:"上传",[t.FONT]:"上传",[t.APP]:"上传",[t.UNKNOWN]:"上传"},ue={[t.IMAGE]:"image/*",[t.VIDEO]:"video/*",[t.AUDIO]:"audio/*",[t.ARCHIVE]:"*/*",[t.DOCUMENT]:"*/*",[t.FONT]:"*/*",[t.APP]:"*/*",[t.UNKNOWN]:"*/*"},xe=20;function Te({open:i,onOpenChange:n,onSelect:h,type:R=t.IMAGE,accept:_,title:L="选择资源",description:B="上传或选择已有资源",pageSize:f=xe}){const Y=Q(),[E,d]=a.useState(0),[N,p]=a.useState(!1),[r,m]=a.useState(null),[u,g]=a.useState(1),j=a.useRef(null),l=R,{data:v,isLoading:T,error:A}=W({queryKey:["resourceList",l,u,f],queryFn:()=>le({type:l,pageNum:u,pageSize:f}),enabled:i}),c=a.useMemo(()=>v?.list??[],[v?.list]),y=v?.total??0,C=Math.max(1,Math.ceil(y/f)),S=u>1,G=u<C,{mutate:k}=X({mutationFn:({file:s,type:o})=>ie(s,o,d),onSuccess:s=>{P.success("上传成功"),Y.invalidateQueries({queryKey:["resourceList",l]}),d(0),p(!1),m(s.id)},onError:s=>{P.error(s instanceof Error?s.message:"上传失败"),d(0),p(!1)}}),K=a.useCallback(s=>{const o=s.target.files?.[0];o&&(p(!0),d(0),k({file:o,type:l}),j.current&&(j.current.value=""))},[l,k]),V=a.useCallback(()=>{j.current?.click()},[]),w=a.useCallback(s=>{m(s.id)},[]),q=a.useCallback(()=>{const s=c.find(o=>o.id===r);s&&(h?.(s),n(!1),m(null))},[c,r,h,n]),D=a.useCallback(s=>{h?.(s),n(!1),m(null)},[h,n]),I=a.useCallback(s=>{s||(m(null),d(0),p(!1),g(1)),n(s)},[n]),z=_??ue[l]??"*/*",$=de[l]??"暂无资源",H=me[l]??"上传",U=l===t.IMAGE;return e.jsx(Z,{open:i,onOpenChange:I,children:e.jsxs(J,{className:"sm:max-w-[700px]",children:[e.jsxs(ee,{children:[e.jsx(se,{children:L}),e.jsx(te,{children:B})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"选择已有资源"}),e.jsx("input",{ref:j,type:"file",accept:z,onChange:K,className:"hidden"}),e.jsx(x,{variant:"outline",size:"sm",onClick:V,disabled:N,children:N?e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"h-4 w-4 animate-spin"}),E,"%"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-4 w-4"}),H]})})]}),N&&e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"h-2 w-full rounded-full bg-muted",children:e.jsx("div",{className:"h-full rounded-full bg-primary transition-all duration-300",style:{width:`${E}%`}})})}),e.jsx(ae,{className:b("mt-4 rounded-md border p-2","h-[400px]"),children:T?e.jsx("div",{className:"flex h-full min-h-[200px] items-center justify-center",children:e.jsx(F,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):A?e.jsx("div",{className:"flex h-full min-h-[200px] items-center justify-center text-destructive",children:"加载失败，请重试"}):c.length===0?e.jsx("div",{className:"flex min-h-[120px] items-center justify-center text-sm text-muted-foreground",children:$}):U?e.jsx("div",{className:"grid w-full min-w-0 grid-cols-4 gap-3",children:c.map(s=>e.jsxs("div",{className:b("group relative min-w-0 cursor-pointer overflow-hidden rounded-lg border-2 transition-all","aspect-square",r===s.id?"border-primary ring-2 ring-primary/30":"border-transparent hover:border-primary/50"),onClick:()=>w(s),onDoubleClick:()=>D(s),children:[e.jsx("img",{src:s.url,alt:s.name,className:"size-full object-contain",loading:"lazy"}),r===s.id&&e.jsx("div",{className:"absolute top-1 right-1 flex h-5 w-5 items-center justify-center rounded-full bg-primary text-primary-foreground",children:e.jsx(M,{className:"h-3 w-3"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-linear-to-t from-black/60 to-transparent p-2 opacity-0 transition-opacity group-hover:opacity-100",children:[e.jsx("p",{className:"truncate text-xs text-white",children:s.name}),e.jsx("p",{className:"text-xs text-white/70",children:O(s.size)})]})]},s.id))}):e.jsx("div",{className:"divide-y",children:c.map(s=>e.jsxs("div",{className:b("flex cursor-pointer items-center gap-3 p-3 transition-colors",r===s.id?"bg-primary/10":"hover:bg-muted/50"),onClick:()=>w(s),onDoubleClick:()=>D(s),children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-muted",children:e.jsx(ne,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsx("p",{className:"truncate font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[O(s.size),s.createdAt&&` · ${s.createdAt}`]})]}),r===s.id&&e.jsx("div",{className:"flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-primary text-primary-foreground",children:e.jsx(M,{className:"h-4 w-4"})})]},s.id))})}),!T&&!A&&c.length>0&&y>f&&e.jsxs("div",{className:"flex items-center justify-center gap-2 border-t pt-3",children:[e.jsxs(x,{type:"button",variant:"outline",size:"sm",disabled:!S,onClick:()=>g(s=>Math.max(1,s-1)),children:[e.jsx(ce,{className:"h-4 w-4"}),"上一页"]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["第 ",u," / ",C," 页，共 ",y," 条"]}),e.jsxs(x,{type:"button",variant:"outline",size:"sm",disabled:!G,onClick:()=>g(s=>Math.min(C,s+1)),children:["下一页",e.jsx(oe,{className:"h-4 w-4"})]})]}),e.jsxs("div",{className:"flex items-center justify-between border-t pt-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:r?"已选择 1 个资源，双击可直接确认":"请选择一个资源"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>I(!1),children:"取消"}),e.jsx(x,{onClick:q,disabled:!r,children:"确认选择"})]})]})]})})}export{Te as R};
