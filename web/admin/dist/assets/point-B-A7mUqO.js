import{m as B,a as Q,r as i,A as Z,j as e,B as L,f as O,J as ee,C as H,l as te,t as $,K as oe}from"./index-Pe1Nv6hH.js";import{u as E}from"./useQuery-DDON36P9.js";import{u as re}from"./useMutation-uvHqRPk1.js";import{u as se,g as ae,c as ne,b as ie}from"./react-icons.esm-CiMB90YA.js";import{S as le}from"./index-BmISbovJ.js";import{I as A}from"./input-DW-mBlUw.js";import{S as G,a as J,b as W,c as X,d as M}from"./select-Dl4KSF7A.js";import{D as w,T as ce,a as ue,b as _,c as pe,d as me,e as k}from"./column-header-Cfszq_dp.js";import{D as de}from"./pagination-B86K5cVv.js";import{g as he}from"./project-_pxXE-N5.js";import{u as je,a as xe,F as fe,b as q,c as R,d as K,e as z,f as U}from"./form-DU65aaqX.js";import{D as ge,a as De,b as Ie,c as ye,d as Ce,e as ve}from"./dialog-DHifiqsD.js";import{P as Se,a as be,b as Ne}from"./popover-CrxLZKyN.js";import{g as we,a as _e,b as Pe,c as Fe,d as Ve,e as ke}from"./command-D9eDedTW.js";import{g as Le}from"./user-D0YkkhRV.js";import{C as Me}from"./chevrons-up-down-BrdDDp5G.js";import{C as Te}from"./index-SpxnGYUf.js";import"./sidebar-BFSPGCEL.js";import"./createLucideIcon-BU8aI1FG.js";import"./index-D68Ta3NN.js";import"./index-C8jai3VV.js";import"./index-4GH7Kv3S.js";import"./dropdown-menu-CbU9G1H2.js";import"./index-BDzuQ5ZL.js";import"./chevron-right-COcvBQ44.js";import"./index-DGhUbGt9.js";import"./search-DNOmmJ4K.js";async function qe(o){const c={pageNum:o?.pageNum??1,pageSize:o?.pageSize??10};return o?.userID!=null&&o.userID!==""&&(c.userID=o.userID),o?.nickname!=null&&o.nickname!==""&&(c.nickname=o.nickname),o?.projectID!=null&&o.projectID!==""&&(c.projectID=o.projectID),await B.get("/api/point",{params:c})}async function Re(o,c){const g=c?.project_id!=null&&c.project_id!==""?{project_id:c.project_id}:void 0;return await B.post("/api/point",o,{params:g})??{}}const Ke=o=>Z({userID:H().min(1,o("features.operation.point.form.validation.userIDRequired")),projectID:H().min(1,o("features.operation.point.form.validation.projectIDRequired")),point:ee().min(1,o("features.operation.point.form.validation.pointRequired"))});function ze({open:o,onOpenChange:c,onSubmit:g,isLoading:d=!1,projectList:C}){const{t:a}=Q(),[x,P]=i.useState(!1),[u,D]=i.useState(""),[f,v]=i.useState(""),T=i.useMemo(()=>Ke(a),[a]),l=je({resolver:xe(T),defaultValues:{userID:"",projectID:"",point:0}}),{data:S,isLoading:F}=E({queryKey:["userList",{current:1,pageNum:1,pageSize:1e3,projectID:f||void 0}],queryFn:()=>Le({current:1,pageNum:1,pageSize:1e3,projectID:f||void 0}),enabled:o&&f!==""}),I=i.useMemo(()=>{const r=S?.users||[];if(!u)return r;const s=u.toLowerCase();return r.filter(p=>p.userID.toLowerCase().includes(s)||p.nickname?.toLowerCase().includes(s)||p.username?.toLowerCase().includes(s))},[S?.users,u]);i.useEffect(()=>{o||(l.reset({userID:"",projectID:"",point:0}),D(""),v(""))},[o,l]),i.useEffect(()=>{const r=l.getValues("projectID");f!==r&&(v(r),l.setValue("userID",""),D(""))},[l.watch("projectID"),l]);function b(r){g({userID:r.userID.trim(),projectID:r.projectID.trim(),point:r.point})}const y=I.find(r=>r.userID===l.watch("userID"));return e.jsx(ge,{open:o,onOpenChange:c,children:e.jsxs(De,{className:"sm:max-w-[600px] max-h-[90vh] flex flex-col",children:[e.jsxs(Ie,{className:"shrink-0",children:[e.jsx(ye,{children:a("features.operation.point.form.dialogTitle")}),e.jsx(Ce,{children:a("features.operation.point.form.createDescription")})]}),e.jsx(fe,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(b),className:"flex-1 overflow-y-auto pr-2 space-y-4 min-h-0",children:[e.jsx(q,{control:l.control,name:"projectID",render:({field:r})=>{const p=(r.value??"").trim()||"__empty__";return e.jsxs(R,{className:"grid grid-cols-[140px_1fr] items-center gap-4 space-y-0",children:[e.jsx(K,{className:"text-right",children:a("features.operation.point.form.project")}),e.jsxs(G,{value:p,onValueChange:m=>{const N=m==="__empty__"?"":m;r.onChange(N),v(N)},children:[e.jsx(z,{children:e.jsx(J,{children:e.jsx(W,{placeholder:a("features.operation.point.form.projectPlaceholder")})})}),e.jsxs(X,{children:[e.jsx(M,{value:"__empty__",children:a("features.operation.point.form.projectPlaceholder")}),C.filter(m=>(m.projectID??"").trim()!=="").map(m=>e.jsx(M,{value:(m.projectID??"").trim(),children:m.title},m.projectID))]})]},`project-${p}`),e.jsx(U,{className:"col-start-2"})]})}}),e.jsx(q,{control:l.control,name:"userID",render:({field:r})=>e.jsxs(R,{className:"grid grid-cols-[140px_1fr] items-center gap-4 space-y-0",children:[e.jsx(K,{className:"text-right",children:a("features.operation.point.form.user")}),e.jsxs(Se,{open:x,onOpenChange:P,children:[e.jsx(be,{asChild:!0,children:e.jsx(z,{children:e.jsxs(L,{variant:"outline",role:"combobox",className:O("w-full justify-between",!r.value&&"text-muted-foreground"),disabled:!f,children:[r.value&&y?`${y.nickname||y.username} (${y.userID})`:a("features.operation.point.form.selectUser"),e.jsx(Me,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),e.jsx(Ne,{className:"w-[400px] p-0",align:"start",children:e.jsxs(we,{shouldFilter:!1,children:[e.jsx(_e,{placeholder:a("features.operation.point.form.searchUser"),value:u,onValueChange:s=>{D(s)}}),e.jsx(Pe,{children:F?e.jsx("div",{className:"py-6 text-center text-sm text-muted-foreground",children:a("features.operation.point.form.loadingUsers")}):I.length===0?e.jsx(Fe,{children:a("features.operation.point.form.noUsers")}):e.jsx(Ve,{children:I.map(s=>e.jsxs(ke,{value:`${s.userID}-${s.nickname||s.username}`,onSelect:()=>{l.setValue("userID",s.userID,{shouldValidate:!0}),P(!1),D("")},children:[e.jsx(Te,{className:O("mr-2 h-4 w-4",r.value===s.userID?"opacity-100":"opacity-0")}),s.nickname||s.username," (",s.userID,")"]},s.userID))})})]})})]}),e.jsx(U,{className:"col-start-2"})]})}),e.jsx(q,{control:l.control,name:"point",render:({field:r})=>e.jsxs(R,{className:"grid grid-cols-[140px_1fr] items-center gap-4 space-y-0",children:[e.jsx(K,{className:"text-right",children:a("features.operation.point.form.point")}),e.jsx(z,{children:e.jsx(A,{type:"number",placeholder:a("features.operation.point.form.pointPlaceholder"),...r,onChange:s=>{const p=s.target.value===""?0:Number(s.target.value);r.onChange(p)},value:r.value||""})}),e.jsx(U,{className:"col-start-2"})]})}),e.jsxs(ve,{className:"shrink-0",children:[e.jsx(L,{type:"button",variant:"outline",onClick:()=>c(!1),disabled:d,children:a("features.operation.point.form.cancel")}),e.jsx(L,{type:"submit",disabled:d,children:d?"...":a("features.operation.point.form.submit")})]})]})})]})})}function Ue(){const{t:o}=Q(),c=te(),[g,d]=i.useState(!1),[C,a]=i.useState([]),[x,P]=i.useState("__all__"),[u,D]=i.useState({pageIndex:0,pageSize:10}),[f,v]=i.useState([]),[T,l]=i.useState({}),{data:S}=E({queryKey:["projectList",{current:1,pageNum:1,pageSize:1e3}],queryFn:()=>he({current:1,pageNum:1,pageSize:1e3})}),F=i.useMemo(()=>S?.projects?.map(t=>({projectID:t.projectID,title:t.title??t.projectID}))??[],[S?.projects]),I=i.useMemo(()=>{const t=n=>{const j=C.find(Y=>Y.id===n);return j?.value&&Array.isArray(j.value)?j.value[0]||"":j?.value||""};return{pageNum:u.pageIndex+1,pageSize:u.pageSize,userID:t("userID")||void 0,nickname:t("nickname")||void 0,projectID:x&&x!=="__all__"&&x.trim()||void 0}},[C,u,x]),{data:b,isLoading:y,error:r}=E({queryKey:["pointList",I],queryFn:()=>qe(I),placeholderData:oe}),s=i.useMemo(()=>b?.points||[],[b?.points]),p=b?.total||0,m=Math.max(1,Math.ceil(p/u.pageSize)),N=re({mutationFn:t=>Re(t,{project_id:t.projectID?.trim()||void 0}),onSuccess:()=>{$.success(o("features.operation.point.createSuccess")),c.invalidateQueries({queryKey:["pointList"]}),d(!1)},onError:t=>{$.error(t instanceof Error?t.message:o("features.operation.point.createError"))}}),V=i.useMemo(()=>[{accessorKey:"userID",header:({column:t})=>e.jsx(w,{column:t,title:o("features.operation.point.point.columns.userID")}),cell:({row:t})=>e.jsx("div",{className:"font-mono",children:t.getValue("userID")??"-"})},{accessorKey:"nickname",header:({column:t})=>e.jsx(w,{column:t,title:o("features.operation.point.point.columns.nickname")}),cell:({row:t})=>e.jsx("div",{className:"font-medium",children:t.getValue("nickname")??"-"})},{accessorKey:"point",header:({column:t})=>e.jsx(w,{column:t,title:o("features.operation.point.point.columns.point")}),cell:({row:t})=>e.jsx("div",{className:"font-medium",children:t.getValue("point")??"-"})},{accessorKey:"reason",header:({column:t})=>e.jsx(w,{column:t,title:o("features.operation.point.point.columns.reason")}),cell:({row:t})=>{const n=t.getValue("reason");return e.jsx("div",{className:"max-w-[200px] truncate text-muted-foreground",title:n,children:n??"-"})}},{accessorKey:"createdAt",header:({column:t})=>e.jsx(w,{column:t,title:o("features.operation.point.point.columns.createdAt")}),cell:({row:t})=>e.jsx("div",{className:"text-muted-foreground whitespace-nowrap",children:t.getValue("createdAt")??"-"})}],[o]),h=se({data:s,columns:V,getCoreRowModel:ne(),getSortedRowModel:ae(),manualPagination:!0,pageCount:m,getRowId:t=>String(t.id??""),onSortingChange:v,onColumnFiltersChange:a,onColumnVisibilityChange:l,onPaginationChange:D,state:{sorting:f,columnFilters:C,columnVisibility:T,pagination:u}});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between px-4 pt-4",children:e.jsx(le,{title:o("features.operation.point.title"),description:o("features.operation.point.description"),children:e.jsxs(L,{onClick:()=>{d(!0)},children:[e.jsx(ie,{className:"h-4 w-4"}),o("features.operation.point.point.createButton")]})})}),e.jsxs("div",{className:"rounded-md border p-6 mx-4",children:[e.jsx("div",{className:"space-y-2 pb-4",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(A,{type:"text",placeholder:o("features.operation.point.point.search.userIDPlaceholder"),value:h.getColumn("userID")?.getFilterValue()??"",onChange:t=>h.getColumn("userID")?.setFilterValue(t.target.value),className:"h-8 w-[200px]"}),e.jsx(A,{type:"text",placeholder:o("features.operation.point.point.search.nicknamePlaceholder"),value:h.getColumn("nickname")?.getFilterValue()??"",onChange:t=>h.getColumn("nickname")?.setFilterValue(t.target.value),className:"h-8 w-[200px]"}),e.jsxs(G,{value:x,onValueChange:P,children:[e.jsx(J,{className:"h-8 w-[160px]",children:e.jsx(W,{placeholder:o("features.operation.point.point.search.project")})}),e.jsxs(X,{children:[e.jsx(M,{value:"__all__",children:o("features.operation.point.point.search.projectAll")}),F.map(t=>e.jsx(M,{value:(t.projectID??"").trim(),children:t.title},t.projectID))]})]})]})}),e.jsxs(ce,{children:[e.jsx(ue,{children:h.getHeaderGroups().map(t=>e.jsx(_,{children:t.headers.map(n=>{const j=n.isPlaceholder?null:typeof n.column.columnDef.header=="function"?n.column.columnDef.header(n.getContext()):n.column.columnDef.header;return e.jsx(pe,{children:j},n.id)})},t.id))}),e.jsx(me,{children:y?e.jsx(_,{children:e.jsx(k,{colSpan:V.length,className:"h-24 text-center",children:o("features.operation.point.point.loading")})}):r?e.jsx(_,{children:e.jsx(k,{colSpan:V.length,className:"h-24 text-center text-destructive",children:o("features.operation.point.point.loadError")})}):h.getRowModel().rows?.length?h.getRowModel().rows.map(t=>e.jsx(_,{children:t.getVisibleCells().map(n=>{const j=typeof n.column.columnDef.cell=="function"?n.column.columnDef.cell(n.getContext()):n.column.columnDef.cell;return e.jsx(k,{children:j},n.id)})},t.id)):e.jsx(_,{children:e.jsx(k,{colSpan:V.length,className:"h-24 text-center",children:o("features.operation.point.point.noData")})})})]}),e.jsx(de,{table:h})]}),e.jsx(ze,{open:g,onOpenChange:t=>{t||d(!1)},onSubmit:t=>N.mutate(t),isLoading:N.isPending,projectList:F})]})}const ht=Ue;export{ht as component};
