const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CAgIQmcy.js","assets/index-Pe1Nv6hH.js","assets/index-BoEWxluP.css","assets/slate-markdown-C4u7coMV.js","assets/dropdown-menu-CbU9G1H2.js","assets/index-SpxnGYUf.js","assets/createLucideIcon-BU8aI1FG.js","assets/index-4GH7Kv3S.js","assets/index-C8jai3VV.js","assets/index-D68Ta3NN.js","assets/index-BDzuQ5ZL.js","assets/chevron-right-COcvBQ44.js","assets/dialog-DHifiqsD.js","assets/input-DW-mBlUw.js","assets/form-DU65aaqX.js","assets/index-DGhUbGt9.js","assets/unlink-DFLq-BTp.js","assets/image-D4KB7jNL.js","assets/minus-BV34uZJO.js"])))=>i.map(i=>d[i]);
import{a as ce,r as d,j as e,u as xe,A as X,t as W,B as m,f as O,M as Y,C as b,Q as Z,J as F,ai as fe}from"./index-Pe1Nv6hH.js";import{u as ge,a as je,F as be,b as p,c as h,d as x,e as f,f as g}from"./form-DU65aaqX.js";import{u as _}from"./useQuery-DDON36P9.js";import{u as ee}from"./useMutation-uvHqRPk1.js";import{I as y}from"./input-DW-mBlUw.js";import{T as K}from"./textarea-D-N386t0.js";import{S as ye}from"./switch-BUI-ezYi.js";import{S as te,a as re,b as se,c as ae,d as oe}from"./select-Dl4KSF7A.js";import{T as Ne,a as ve,b as H,c as Q}from"./tabs-Dqfr2yce.js";import{S as Pe}from"./index-BmISbovJ.js";import{E as ke}from"./editor-error-boundary-8LYWESTP.js";import{R as Se}from"./index-B79q5nRO.js";import{g as Ce,a as Ie,b as De,c as Te,d as we,e as Le}from"./command-D9eDedTW.js";import{P as qe,a as Fe,b as Ee}from"./popover-CrxLZKyN.js";import{B as _e}from"./badge-T19Q3klL.js";import{s as Me}from"./slate-markdown-C4u7coMV.js";import{c as Ve,u as Re,a as ze}from"./product-Cl-dx2lJ.js";import{g as Ae}from"./product-category-Do59GkcM.js";import{g as Be}from"./project-_pxXE-N5.js";import{g as Oe}from"./tag-BQ1zh2fc.js";import{A as Ke,P as He}from"./plus-w5piNt_B.js";import{X as U}from"./index-D68Ta3NN.js";import{I as Qe}from"./image-D4KB7jNL.js";import{C as Ue}from"./chevrons-up-down-BrdDDp5G.js";import{C as $e}from"./index-SpxnGYUf.js";const Ge=d.lazy(()=>fe(()=>import("./index-CAgIQmcy.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18])).then(i=>({default:i.SlateEditor}))),Je=i=>X({title:b().min(1,i("features.store.product.form.validation.titleRequired")),description:b().optional(),content:b().optional(),images:Y(b()).default([]),categoryID:b().min(1,i("features.store.product.form.validation.categoryRequired")),projectID:b().min(1,i("features.store.product.form.validation.projectRequired")),buyLimit:Z().min(0).default(1),enable:Z().optional(),tag:b().optional(),sku:Y(X({skuTitle:b(),costPrice:F(),marketPrice:F(),unitPrice:F(),unitPoint:F(),quantity:F()})).optional()}),ne=1,$=2,M=3,ie={skuTitle:"",costPrice:1,marketPrice:1,unitPrice:1,unitPoint:1,quantity:1};function Xe(i){return i?.length?i.map(n=>({skuTitle:n.skuTitle??"",costPrice:n.costPrice??1,marketPrice:n.marketPrice??1,unitPrice:n.unitPrice??1,unitPoint:n.unitPoint??1,quantity:n.quantity??1,skuID:n.skuID?.trim()})):[{...ie}]}function We({productID:i,product:n,projectList:N,tagList:w,flattenCategories:v}){const{t:r}=ce(),P=xe(),V=d.useMemo(()=>Je(r),[r]),u=!!i,[R,S]=d.useState(!1),[C,I]=d.useState("basic"),[j,L]=d.useState(u?M:ne),[k,q]=d.useState(()=>Xe(n?.sku??null)),c=ge({resolver:je(V),defaultValues:{title:n?.title??"",description:n?.description??"",content:n?.content??"",images:Array.isArray(n?.images)?[...n.images]:[],categoryID:n?.categoryID??"",projectID:n?.projectID??"",buyLimit:n?.buyLimit??1,enable:n?.enable??1,tag:n?.tag??""}}),D=t=>{(t==="basic"?ne:t==="spec"?$:M)<=j&&I(t)},E=async()=>{await c.trigger(["title","description","images","categoryID","projectID","buyLimit","enable"])&&(L(Math.max(j,$)),I("spec"))},le=()=>{L(Math.max(j,M)),I("detail")};d.useEffect(()=>{!u&&N.length>0&&!c.getValues("projectID")&&c.setValue("projectID",N[0].projectID)},[u,N,c]),d.useEffect(()=>{!u&&v.length>0&&!c.getValues("categoryID")&&c.setValue("categoryID",v[0].id)},[u,v,c]);const G=ee({mutationFn:t=>Ve(t),onSuccess:()=>{W.success(r("features.store.product.form.createSuccess")),P({to:"/store/product"})}}),J=ee({mutationFn:t=>Re(t.productID,t),onSuccess:()=>{W.success(r("features.store.product.form.updateSuccess")),P({to:"/store/product"})}}),de=async t=>{const s=Me(t.content??""),o=k.filter(a=>a.skuTitle.trim()||a.unitPrice>0||a.quantity>0);if(u&&i){const a={productID:i,title:t.title,productNumber:n?.productNumber??"",projectID:t.projectID,description:t.description,images:t.images?.length?t.images:void 0,video:n?.video??"",buyLimit:t.buyLimit??1,categoryID:t.categoryID,specIds:n?.specIds??"",content:t.content,Htmlcontent:s,enable:t.enable??1,createdAt:n?.createdAt,tag:t.tag||void 0,htmlContent:s,sku:o.length?o.map(l=>({skuID:l.skuID,skuTitle:l.skuTitle,costPrice:l.costPrice,marketPrice:l.marketPrice,unitPrice:l.unitPrice,unitPoint:l.unitPoint,quantity:l.quantity})):void 0};J.mutate(a)}else{const a={title:t.title,content:t.content,htmlContent:s,description:t.description,images:t.images?.length?t.images:void 0,categoryID:t.categoryID,projectID:t.projectID,buyLimit:t.buyLimit??1,enable:t.enable??1,tag:t.tag||void 0,sku:o.length?o:void 0};a.sku?.length===0&&delete a.sku,G.mutate(a)}},ue=t=>{const s=c.getValues("images")??[];c.setValue("images",[...s,t.url]),S(!1)},me=t=>{const s=c.getValues("images")??[];c.setValue("images",s.filter((o,a)=>a!==t))},pe=()=>q(t=>[...t,{...ie}]),he=t=>{k.length<=1||q(s=>s.filter((o,a)=>a!==t))},T=(t,s,o)=>{q(a=>{const l=[...a];return l[t]={...l[t],[s]:o},l})},z=G.isPending||J.isPending;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex gap-4 px-4 pt-4",children:[e.jsx(m,{type:"button",variant:"ghost",size:"icon",onClick:()=>P({to:"/store/product"}),"aria-label":r("features.store.product.form.cancel"),children:e.jsx(Ke,{className:"h-4 w-4"})}),e.jsx(Pe,{title:r(u?"features.store.product.form.editTitle":"features.store.product.form.createTitle"),description:r(u?"features.store.product.form.editDescription":"features.store.product.form.createDescription")})]}),e.jsx("div",{className:"rounded-md border p-6 mx-4 bg-background",children:e.jsx(be,{...c,children:e.jsxs("form",{onSubmit:c.handleSubmit(de),className:"flex flex-col gap-6",children:[e.jsxs(Ne,{value:C,onValueChange:D,className:"w-full",children:[e.jsxs(ve,{className:"w-full justify-start border-b rounded-none h-auto p-0 bg-transparent",children:[e.jsx(H,{value:"basic",className:"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2",children:r("features.store.product.form.tabBasicInfo")}),e.jsx(H,{value:"spec",disabled:j<$,className:"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2",children:r("features.store.product.form.tabSpec")}),e.jsx(H,{value:"detail",disabled:j<M,className:"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2",children:r("features.store.product.form.tabDetail")})]}),e.jsxs(Q,{value:"basic",className:"pt-6 space-y-6",children:[e.jsx(p,{control:c.control,name:"title",render:({field:t})=>e.jsxs(h,{className:"grid grid-cols-[100px_1fr] items-center gap-4 space-y-0",children:[e.jsx(x,{className:"text-right",children:r("features.store.product.form.title")}),e.jsx(f,{children:e.jsx(y,{placeholder:r("features.store.product.form.titlePlaceholder"),...t})}),e.jsx(g,{className:"col-start-2"})]})}),e.jsx(p,{control:c.control,name:"description",render:({field:t})=>e.jsxs(h,{className:"grid grid-cols-[100px_1fr] items-start gap-4 space-y-0",children:[e.jsx(x,{className:"text-right pt-2",children:r("features.store.product.form.description")}),e.jsx(f,{children:e.jsx(K,{placeholder:r("features.store.product.form.descriptionPlaceholder"),className:"resize-none min-h-[88px]",...t})}),e.jsx(g,{className:"col-start-2"})]})}),e.jsx(p,{control:c.control,name:"images",render:({field:t})=>e.jsxs(h,{className:"grid grid-cols-[100px_1fr] items-start gap-4 space-y-0",children:[e.jsx(x,{className:"text-right pt-2",children:r("features.store.product.form.images")}),e.jsx(f,{children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(t.value??[]).map((s,o)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:s,alt:"",className:"h-20 w-20 rounded object-cover border"}),e.jsx("button",{type:"button",onClick:()=>me(o),className:"absolute -top-1 -right-1 h-5 w-5 rounded-full bg-destructive text-destructive-foreground flex items-center justify-center opacity-0 group-hover:opacity-100 transition",children:e.jsx(U,{className:"h-3 w-3"})})]},o)),e.jsxs("button",{type:"button",onClick:()=>S(!0),className:O("flex flex-col items-center justify-center h-20 w-20 rounded-lg border-2 border-dashed border-border bg-muted/30 shrink-0","cursor-pointer hover:border-primary/50 hover:bg-muted/50"),children:[e.jsx(Qe,{className:"h-8 w-8 text-muted-foreground mb-1"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r("features.store.product.form.addImage")})]})]})}),e.jsx(g,{className:"col-start-2"})]})}),e.jsxs("div",{className:"space-y-4 max-w-xl",children:[e.jsx(p,{control:c.control,name:"categoryID",render:({field:t})=>e.jsxs(h,{className:"grid grid-cols-[100px_1fr] items-center gap-4 space-y-0",children:[e.jsx(x,{className:"text-right",children:r("features.store.product.form.category")}),e.jsxs(te,{onValueChange:t.onChange,value:t.value||void 0,children:[e.jsx(f,{children:e.jsx(re,{children:e.jsx(se,{placeholder:r("features.store.product.form.categoryPlaceholder")})})}),e.jsx(ae,{children:v.map(s=>e.jsx(oe,{value:s.id,children:e.jsx("span",{style:{paddingLeft:`${s.level*10}px`},children:s.title})},s.id))})]}),e.jsx(g,{className:"col-start-2"})]})}),e.jsx(p,{control:c.control,name:"projectID",render:({field:t})=>e.jsxs(h,{className:"grid grid-cols-[100px_1fr] items-center gap-4 space-y-0",children:[e.jsx(x,{className:"text-right",children:r("features.store.product.form.project")}),e.jsxs(te,{onValueChange:t.onChange,value:t.value||void 0,children:[e.jsx(f,{children:e.jsx(re,{children:e.jsx(se,{placeholder:r("features.store.product.form.projectPlaceholder")})})}),e.jsx(ae,{children:N.map(s=>e.jsx(oe,{value:s.projectID,children:s.title},s.projectID))})]}),e.jsx(g,{className:"col-start-2"})]})}),e.jsx(p,{control:c.control,name:"buyLimit",render:({field:t})=>e.jsxs(h,{className:"grid grid-cols-[100px_1fr] items-center gap-4 space-y-0",children:[e.jsx(x,{className:"text-right",children:r("features.store.product.form.buyLimit")}),e.jsx(f,{children:e.jsx(y,{type:"number",min:0,...t})}),e.jsx(g,{className:"col-start-2"})]})}),e.jsx(p,{control:c.control,name:"enable",render:({field:t})=>e.jsxs(h,{className:"grid grid-cols-[100px_1fr] items-center gap-4 space-y-0",children:[e.jsx(x,{className:"text-right",children:r("features.store.product.form.enable")}),e.jsx(f,{children:e.jsx(ye,{checked:t.value===1,onCheckedChange:s=>t.onChange(s?1:2)})}),e.jsx(g,{className:"col-start-2"})]})})]})]}),e.jsxs(Q,{value:"spec",className:"pt-6 space-y-6",children:[e.jsx(p,{control:c.control,name:"tag",render:({field:t})=>{const s=t.value?t.value.split(",").filter(Boolean):[],o=w.filter(a=>s.includes(a.tagID));return e.jsxs(h,{className:"grid grid-cols-[100px_1fr] items-center gap-4 space-y-0",children:[e.jsx(x,{className:"text-right",children:r("features.store.product.form.tag")}),e.jsxs(qe,{children:[e.jsx(Fe,{asChild:!0,children:e.jsx(f,{children:e.jsxs(m,{variant:"outline",role:"combobox",className:O("w-full justify-between h-auto min-h-10",!s.length&&"text-muted-foreground"),children:[e.jsx("div",{className:"flex flex-wrap gap-1",children:o.length>0?o.map(a=>e.jsxs(_e,{variant:"secondary",className:"mr-1",children:[a.title,e.jsx("div",{className:"ml-1 ring-offset-background rounded-full outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 cursor-pointer",onMouseDown:l=>{l.preventDefault(),l.stopPropagation()},onClick:l=>{l.preventDefault(),l.stopPropagation();const A=s.filter(B=>B!==a.tagID);t.onChange(A.join(","))},children:e.jsx(U,{className:"h-3 w-3 text-muted-foreground hover:text-foreground"})})]},a.tagID)):e.jsx("span",{children:r("features.store.product.form.tagPlaceholder")})}),e.jsx(Ue,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),e.jsx(Ee,{className:"w-[400px] p-0",align:"start",children:e.jsxs(Ce,{children:[e.jsx(Ie,{placeholder:r("features.store.product.form.tagPlaceholder")}),e.jsxs(De,{children:[e.jsx(Te,{children:"No tag found."}),e.jsx(we,{children:w.map(a=>e.jsxs(Le,{value:a.title,onSelect:()=>{const A=s.includes(a.tagID)?s.filter(B=>B!==a.tagID):[...s,a.tagID];t.onChange(A.join(","))},children:[e.jsx($e,{className:O("mr-2 h-4 w-4",s.includes(a.tagID)?"opacity-100":"opacity-0")}),a.title]},a.tagID))})]})]})})]}),e.jsx(g,{className:"col-start-2"})]})}}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{children:r("features.store.product.form.sku")}),e.jsxs(m,{type:"button",variant:"outline",size:"sm",onClick:pe,children:[e.jsx(He,{className:"h-4 w-4 mr-1"}),r("features.store.product.form.addSku")]})]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b bg-muted/50",children:[e.jsx("th",{className:"text-left p-2 font-medium",children:r("features.store.product.form.skuTitle")}),e.jsx("th",{className:"text-left p-2 font-medium",children:r("features.store.product.form.costPrice")}),e.jsx("th",{className:"text-left p-2 font-medium",children:r("features.store.product.form.marketPrice")}),e.jsx("th",{className:"text-left p-2 font-medium",children:r("features.store.product.form.unitPrice")}),e.jsx("th",{className:"text-left p-2 font-medium",children:r("features.store.product.form.unitPoint")}),e.jsx("th",{className:"text-left p-2 font-medium",children:r("features.store.product.form.quantity")}),e.jsx("th",{className:"w-10"})]})}),e.jsx("tbody",{children:k.map((t,s)=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"p-2",children:e.jsx(y,{value:t.skuTitle,onChange:o=>T(s,"skuTitle",o.target.value),placeholder:r("features.store.product.form.skuTitlePlaceholder"),className:"h-8"})}),e.jsx("td",{className:"p-2",children:e.jsx(y,{type:"number",min:0,value:t.costPrice||"",onChange:o=>T(s,"costPrice",Number(o.target.value)||0),className:"h-8 w-24"})}),e.jsx("td",{className:"p-2",children:e.jsx(y,{type:"number",min:0,value:t.marketPrice||"",onChange:o=>T(s,"marketPrice",Number(o.target.value)||0),className:"h-8 w-24"})}),e.jsx("td",{className:"p-2",children:e.jsx(y,{type:"number",min:0,value:t.unitPrice||"",onChange:o=>T(s,"unitPrice",Number(o.target.value)||0),className:"h-8 w-24"})}),e.jsx("td",{className:"p-2",children:e.jsx(y,{type:"number",min:0,value:t.unitPoint||"",onChange:o=>T(s,"unitPoint",Number(o.target.value)||0),className:"h-8 w-24"})}),e.jsx("td",{className:"p-2",children:e.jsx(y,{type:"number",min:0,value:t.quantity||"",onChange:o=>T(s,"quantity",Number(o.target.value)||0),className:"h-8 w-24"})}),e.jsx("td",{className:"p-2",children:e.jsx(m,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>he(s),disabled:k.length<=1,children:e.jsx(U,{className:"h-4 w-4"})})})]},s))})]})})]})]}),e.jsx(Q,{value:"detail",className:"pt-6",children:e.jsx(p,{control:c.control,name:"content",render:({field:t})=>e.jsxs(h,{className:"flex flex-col gap-2",children:[e.jsx(f,{children:e.jsx(ke,{fallback:e.jsx("div",{className:"rounded-md border border-input bg-background flex flex-col min-h-[500px] overflow-hidden",children:e.jsx(K,{className:"flex-1 min-h-0 resize-none font-mono text-sm rounded-none border-0 focus-visible:ring-0",value:t.value??"",onChange:t.onChange})}),children:e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"rounded-md border border-input bg-background flex flex-col min-h-[500px] overflow-hidden",children:e.jsx(K,{className:"flex-1 min-h-0 resize-none font-mono text-sm rounded-none border-0 focus-visible:ring-0",value:t.value??"",readOnly:!0,disabled:!0})}),children:e.jsx(Ge,{value:t.value??"",onChange:t.onChange,minHeight:"min-h-[500px]",outputMode:"json"})})})}),e.jsx(g,{})]})})})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsx(m,{type:"button",variant:"outline",onClick:()=>P({to:"/store/product"}),disabled:z,className:"mr-auto",children:r("features.store.product.form.cancel")}),C==="basic"&&e.jsx(m,{type:"button",onClick:E,children:r("features.store.product.form.nextStep")}),C==="spec"&&e.jsxs(e.Fragment,{children:[e.jsx(m,{type:"button",variant:"secondary",onClick:()=>I("basic"),children:r("features.store.product.form.prevStep")}),e.jsx(m,{type:"button",onClick:le,children:r("features.store.product.form.nextStep")})]}),C==="detail"&&e.jsxs(e.Fragment,{children:[e.jsx(m,{type:"button",variant:"secondary",onClick:()=>I("spec"),children:r("features.store.product.form.prevStep")}),e.jsx(m,{type:"submit",disabled:z,children:r(z?"features.store.product.form.submitting":u?"features.store.product.form.save":"features.store.product.form.create")})]})]})]})})}),e.jsx(Se,{open:R,onOpenChange:S,type:1,onSelect:ue})]})}function Pt({productID:i}){const{t:n}=ce(),N=!!i,{data:w}=_({queryKey:["productCategoryTree"],queryFn:Ae}),{data:v}=_({queryKey:["projectList",{current:1,pageNum:1,pageSize:1e3}],queryFn:()=>Be({current:1,pageNum:1,pageSize:1e3})}),r=d.useMemo(()=>v?.projects??[],[v?.projects]),{data:P}=_({queryKey:["tagList",{pageNum:1,pageSize:1e3}],queryFn:()=>Oe({pageNum:1,pageSize:1e3})}),V=d.useMemo(()=>P?.tags??[],[P?.tags]),{data:u,isLoading:R}=_({queryKey:["product",i],queryFn:()=>ze(i),enabled:!!N&&!!i}),S=u??null,C=d.useMemo(()=>{const j=[],L=(q,c=0)=>{q.forEach(D=>{const E=(D.productCategoryID??"").trim();E&&j.push({id:E,title:D.title,level:c}),D.children?.length&&L(D.children,c+1)})},k=w?.productCategoryTree;return k?.length&&L(k),j},[w]);return N&&!!i&&R?e.jsx("div",{className:"flex items-center justify-center min-h-[200px] px-4",children:e.jsx("p",{className:"text-muted-foreground",children:n("features.store.product.loading")})}):e.jsx(We,{productID:i,product:S,projectList:r,tagList:V,flattenCategories:C},S?.productID??"new")}export{Pt as P};
